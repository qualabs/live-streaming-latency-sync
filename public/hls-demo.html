<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Synchronized live playback with HLS.js</title>

    <script src="../dist/hls.js"></script>
    <script src="./playerSyncPlugin.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <style>
        table { border-spacing: 10px; }
        video { width: 100%; }
        .clock { color: #000; font-size: 60pt }
        .margin-top-row { margin-top: 2rem; }
    </style>
</head>
<body>
<main>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <img class="" src="https://raw.githubusercontent.com/video-dev/hls.js/master/docs/logo.svg" width="100" alt="HLS.js logo">
        </header>
        <div class="row margin-top-row">
            <div class="col-md-12">
                <div class="h-100 p-5 bg-light border rounded-3">
                    <h3>Synchronized live playback</h3>
                    <p>This sample illustrates how to use global player synchronization with HLS.js.</p>
                </div>
            </div>
        </div>
        <div class="row margin-top-row">
            <div class="input-group">
                <button id="load-button" type="button" class="btn btn-primary" aria-haspopup="true" aria-expanded="false">Load</button>
                <select id="url-select" class="dropdown-toggle">
                    <option value="custom">Custom</option>
                    <option value="https://demo.gvideo.io/cmaf/2675_19146/master.m3u8">Low latency Live (DASH/HLS)</option>
                </select>
                <input id="custom-url" type="text" class="form-control" placeholder="Paste your own HLS manifest URL here" style="margin-left: 8px;">
            </div>
        </div>
        <div class="row margin-top-row">
            <div class="col-md-12">
                <div class="h-100 p-5 border rounded-3">
                    <h5> Player 1</h5>
                    <div class="code">
                        <video id="video" controls muted></video>
                        <div>
                            <div><i class="bi bi-arrow-right-square"></i> Seconds behind live: <span id="liveLatency"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Buffer length: <span id="bufferLength"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Playback rate: <span id="playbackRate"></span></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
        <footer class="pt-3 mt-4 text-muted border-top">
            &copy; HLS.js Demo
        </footer>
    </div>
</main>
<script>
      document.addEventListener('DOMContentLoaded', function () {
        const video = document.getElementById('video');
        const liveLatencySpan = document.getElementById('liveLatency');
        const bufferLengthSpan = document.getElementById('bufferLength');
        const playbackRateSpan = document.getElementById('playbackRate');

        let hls = null;
        let adapter = null;
        let liveLatency = 0;
        let sessionId = crypto.randomUUID();
        let currentUrl = '';
        const loadButton = document.getElementById('load-button');
        const urlSelect = document.getElementById('url-select');
        const customUrl = document.getElementById('custom-url');

        urlSelect.addEventListener('change', () => {
          if (urlSelect.value === 'custom') {
            customUrl.disabled = false;
            customUrl.value = '';
          } else {
            customUrl.value = urlSelect.value;
            customUrl.disabled = true;
          }
        });

        loadButton.addEventListener('click', () => {
          currentUrl = customUrl.value.trim() || urlSelect.value;
          if (hls) {
            hls.destroy();
            hls = null;
          }
          sessionId = crypto.randomUUID();
          hls = new Hls({
            cmcd: {
              enabled: true,
              sessionId: sessionId,
              contentId: 'sync-content',
              version: 2
            },
            xhrSetup: function(xhr, url) {
              let parsedUrl = new URL(url);
              let cmcdParam = parsedUrl.searchParams.get('CMCD');
              if (cmcdParam) {
                let ltcValue = Math.round(liveLatency * 1000);
                let newCmcdParam = cmcdParam + `,ltc=${ltcValue},ts=${Date.now()}`;
                parsedUrl.searchParams.set('CMCD', newCmcdParam);
                xhr.open(xhr.method || 'GET', parsedUrl.toString(), true);
                if (adapter) {
                  playerSyncPlugin.updateLatency(newCmcdParam, adapter);
                }
              }
            }
          });
          window.player = hls;

          if (Hls.isSupported()) {
            hls.loadSource(currentUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MEDIA_ATTACHED, function () {
              video.play();
            });
            adapter = playerSyncPlugin.createplayerSyncPlugin('hls', hls, video);
            playerSyncPlugin.startSyncrhonization(adapter);
          }

          setInterval(() => {
            liveLatency = 0;
            if (hls && hls.latency !== undefined && video) {
              liveLatency = hls.latency;
            }

            liveLatencySpan.innerHTML = parseFloat(liveLatency || 0).toFixed(2);

            let bufferLength = 0;
            if (video && video.buffered.length > 0) {
              for (let i = 0; i < video.buffered.length; i++) {
                const start = video.buffered.start(i);
                const end = video.buffered.end(i);
                if (start <= video.currentTime && video.currentTime <= end) {
                  bufferLength = end - video.currentTime;
                  break;
                }
              }
            }
            bufferLengthSpan.innerHTML = parseFloat(bufferLength || 0).toFixed(2) + 's';
            playbackRateSpan.innerHTML = parseFloat(video.playbackRate || 1).toFixed(2);
          }, 100);
        });
      }); 
    </script>
  </body>
</html>
