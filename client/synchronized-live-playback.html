<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Synchronized live playback</title>

    <script src="./dist/modern/umd/dash.all.debug.js"></script>
    <script src="./playerSynchronizationPlugin.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.3.2/dist/chart.min.js"></script>

    <!-- Bootstrap core CSS -->
    <link href="./lib/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css">
    <link href="./lib/main.css" rel="stylesheet">

    <script class="code">
        function init() {
            var player1, player2, video;

            video = document.querySelector('#video1');
            player1 = dashjs.MediaPlayer().create();
            window.player1 = player1;

            player1.initialize(video,'' ,true);
            playerSynchronization.addFollower(player1, {
                globalSync: true,
                url: 'http://localhost:3000/'
            });

            video = document.querySelector('#video2');
            player2 = dashjs.MediaPlayer().create();
            window.player2 = player2;

            player2.initialize(video, '', true);
            playerSynchronization.addFollower(player2, {
                globalSync: true,
                url: 'http://localhost:3000/'
            });

            const loadButton = document.getElementById('load-button');
            const urlSelect = document.getElementById('url-select');
            const customUrl = document.getElementById('custom-url');

            loadButton.addEventListener('click', () => {
                const enteredUrl = customUrl.value.trim();
                const selectedUrl = urlSelect.value;
                player1.attachSource(enteredUrl !== '' ? enteredUrl : selectedUrl);
                player2.attachSource(enteredUrl !== '' ? enteredUrl : selectedUrl);

                setInterval(function () {
                    const d = Math.abs(player1.time() - player2.time()).toFixed(4)
                    document.querySelector('#difference').innerHTML = d;
                    for (var i = 1; i < 3; i++) {
                        var p = eval('player' + i);
                        document.querySelector('#video' + i + 'delay').innerHTML = parseFloat(p.getCurrentLiveLatency(), 10);
                        document.querySelector('#video' + i + 'buffer').innerHTML = p.getBufferLength() + 's';
                        document.querySelector('#video' + i + 'rate').innerHTML = p.getPlaybackRate().toFixed(2);
                    }
                }, 1000);
            });
        }
    </script>
    <style>

        table {
            border-spacing: 10px;
        }

        video {
            width: 462px;
            height: 260px;
        }

        .clock {
            color: #000;
            font-size: 60pt
        }
    </style>
</head>
<body>

<main>
    <div class="container py-4">
        <header class="pb-3 mb-4 border-bottom">
            <img class=""
                 src="./lib/img/dashjs-logo.png"
                 width="200">
        </header>
        <div class="row margin-top-row">
            <div class="col-md-8">
                <div class="h-100 p-5 bg-light border rounded-3">
                    <h3>Synchronized live playback</h3>
                    <p>This sample illustrates how to use tglobal player synchronization.</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="h-100 p-5 border rounded-3">
                    <h3>Player time difference</h3>
                    <div class="clock">
                        <span id="difference"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row margin-top-row">
            <div class="input-group">
                <button id="load-button" type="button" class="btn btn-primary" aria-haspopup="true" aria-expanded="false">Load</button>
                <select id="url-select" class="dropdown-toggle">
                    <option
                        value="https://livesim.dashif.org/livesim2/WAVE/vectors/cfhd_sets/12.5_25_50/t1/2022-10-17/stream.mpd">
                        Live Sim</option>
                    <option value="https://cmafref.akamaized.net/cmaf/live-ull/2006350/akambr/out.mpd">Low latency Live
                    </option>
                </select>
                <input id="custom-url" type="text" class="form-control" placeholder="Paste your own DASH manifest URL here" style="margin-left: 8px;">
            </div>
        </div>
        <div class="row margin-top-row">
            <div class="col-md-6">
                <div class="h-100 p-5 border rounded-3">
                    <h5> Player 1</h5>
                    <div class="code">
                        <video id="video1" controls="true" muted></video>
                        <div>
                            <div><i class="bi bi-arrow-right-square"></i> Seconds behind live: <span
                                id="video1delay"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Buffer length: <span
                                id="video1buffer"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Playback rate: <span id="video1rate"></span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="h-100 p-5 border rounded-3">
                    <h5> Player 2</h5>
                    <div class="code">
                        <video id="video2" controls="true" muted></video>
                        <div>
                            <div><i class="bi bi-arrow-right-square"></i> Seconds behind live: <span
                                id="video2delay"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Buffer length: <span
                                id="video2buffer"></span></div>
                            <div><i class="bi bi-arrow-right-square"></i> Playback rate: <span id="video2rate"></span></div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <canvas id="metric-chart-player1" style="height: 300px;"></canvas>
            </div>
            <div class="col-lg-6">
                <canvas id="metric-chart-player2" style="height: 300px;"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="code-output"></div>
            </div>
        </div>
        <footer class="pt-3 mt-4 text-muted border-top">
            &copy; DASH-IF
        </footer>
    </div>
</main>
<script class="code">
    document.addEventListener('DOMContentLoaded', function () {
        init();
        setupCharts();
    });

    function setupCharts() {
        setupChart('metric-chart-player1', player1);
        setupChart('metric-chart-player2', player2);
    }

    function setupChart(chartId, player) {
        const data = {
            datasets: [
                { label: 'Live delay', borderColor: '#3944bc', backgroundColor: '#3944bc' },
                { label: 'Buffer level', borderColor: '#d0312d', backgroundColor: '#d0312d' },
                { label: 'Playback rate', borderColor: '#3cb043', backgroundColor: '#3cb043' }
            ]
        };
        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    y: { min: 0, ticks: { stepSize: 0.5 }, title: { display: true, text: 'Value in Seconds' } },
                    x: { title: { display: true, text: 'Time (s)' } }
                },
                plugins: {
                    legend: { position: 'top' },
                    title: { display: true, text: 'Live Data Metrics' }
                }
            }
        };
        const chart = new Chart(document.getElementById(chartId), config);

        setInterval(() => {
            if (player && player.isReady()) {
                const dashMetrics = player.getDashMetrics();
                const labels = chart.data.labels;
                const datasets = chart.data.datasets;

                if (labels.length > 30) labels.shift();
                labels.push((labels.length + 1).toString());

                if (datasets[0].data.length > 30) datasets[0].data.shift();
                datasets[0].data.push(parseFloat(player.getCurrentLiveLatency()).toFixed(2));

                if (datasets[1].data.length > 30) datasets[1].data.shift();
                datasets[1].data.push(parseFloat(dashMetrics.getCurrentBufferLevel('video')).toFixed(2));

                if (datasets[2].data.length > 30) datasets[2].data.shift();
                datasets[2].data.push(parseFloat(player.getPlaybackRate()).toFixed(2));

                chart.update();
            }
        }, 1000);
    }
</script>
<script src="./highlighter.js"></script>
</body>
</html>
